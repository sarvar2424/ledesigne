import React, { useEffect, useMemo, useRef, useState } from "react";
import {
  Wallet,
  Search,
  Filter,
  Download,
  Lock,
  Unlock,
  ChevronLeft,
  ChevronRight,
  Plus,
  Trash2,
  Edit3,
  Copy,
  BookmarkPlus,
  AlertTriangle,
  ArrowDownCircle,
  ArrowUpCircle,
  ArrowRightLeft,
  DollarSign,
  PiggyBank,
  BarChart2,
  PieChart,
  CalendarClock,
  Users,
  UserPlus,
  Bell,
  Check,
} from "lucide-react";

/**
 * LEORA â€” FINANCE (Canvas Preview)
 * Premiumâ€‘only Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ. ĞÑ„Ğ»Ğ°Ğ¹Ğ½â€‘Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ UX. Ğ‘Ğ¸Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ/Ğ¼Ğ°ÑĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° ÑÑƒĞ¼Ğ¼. Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚. Ğ‘ÑĞ´Ğ¶ĞµÑ‚Ñ‹/Ğ¦ĞµĞ»Ğ¸/ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°/Ğ’Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹.
 *
 * Ğ’ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾:
 *  - Ğ¥ĞµĞ´ĞµÑ€ Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¾Ğ¼ (Ğ¼ĞµÑÑÑ†), Ğ¿Ğ¾Ğ¸ÑĞº/Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹/ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚, Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¼Ğ°ÑĞºĞ¸ ÑÑƒĞ¼Ğ¼, Dark/Light
 *  - ĞšĞ°Ñ€Ñ‚Ğ° Â«ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½ÑÂ» (sparkline), Ğ¼ĞµÑÑÑ‡Ğ½Ñ‹Ğ¹ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ¾Ğ² (ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ/Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·/SMA)
 *  - Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ¸: Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Â· Ğ‘ÑĞ´Ğ¶ĞµÑ‚Ñ‹ Â· Ğ¦ĞµĞ»Ğ¸ Â· Ğ’Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹ Â· ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°
 *  - CRUDâ€‘Ğ»Ğ¸ÑÑ‚Ñ‹ (ÑĞ¼ÑƒĞ»ÑÑ†Ğ¸Ñ): Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ/ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ/Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ/Ğ² ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½
 *  - FABâ€‘Ğ²ĞµĞµÑ€: Ğ Ğ°ÑÑ…Ğ¾Ğ´ Â· Ğ”Ğ¾Ñ…Ğ¾Ğ´ Â· ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´ Â· Ğ”Ğ¾Ğ»Ğ³
 *  - ĞĞ»ĞµÑ€Ñ‚ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½Ğ¸Ñ Ğ±ÑĞ´Ğ¶ĞµÑ‚Ğ°, ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° Â«ĞĞµĞ¾Ğ±Ñ‹Ñ‡Ğ½Ğ°Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸ÑÂ»
 */

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ«
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
const clamp = (v: number, min: number, max: number) => Math.min(Math.max(v, min), max);
const toCurrency = (n: number) => new Intl.NumberFormat("ru-RU", { style: "currency", currency: "RUB", maximumFractionDigits: 0 }).format(n);
const sum = (arr: number[]) => arr.reduce((a, b) => a + b, 0);

function sma(values: number[], windowSize = 7) {
  const out: number[] = [];
  for (let i = 0; i < values.length; i++) {
    const start = Math.max(0, i - windowSize + 1);
    const slice = values.slice(start, i + 1);
    out.push(sum(slice) / slice.length);
  }
  return out;
}

// Ğ§Ğ¸ÑÑ‚Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´ÑÑ‡Ñ‘Ñ‚Ğ° Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ² Ğ¿Ğ¾ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ°Ğ¼ â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¸ Ğ² UI, Ğ¸ Ğ² Ğ¼Ğ¸Ğ½Ğ¸â€‘Ñ‚ĞµÑÑ‚Ğ°Ñ…
function calcSettlementsTotals(list: Array<{ net: number }>) {
  const youOwe = list.filter((s) => s.net < 0).reduce((a, b) => a + Math.abs(b.net), 0);
  const oweYou = list.filter((s) => s.net > 0).reduce((a, b) => a + b.net, 0);
  return { youOwe, oweYou };
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// ĞšĞĞœĞŸĞĞĞ•ĞĞ¢Ğ«: Sparkline Ğ¸ ĞœĞµÑÑÑ‡Ğ½Ğ°Ñ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
function Sparkline({ points, color = "#0ea5e9" }: { points: number[]; color?: string }) {
  const W = 180, H = 48;
  const max = Math.max(1, ...points);
  const path = points
    .map((v, i) => {
      const x = (i / (points.length - 1)) * W;
      const y = H - (v / max) * (H - 4) - 2;
      return `${i === 0 ? "M" : "L"}${x.toFixed(1)},${y.toFixed(1)}`;
    })
    .join(" ");
  return (
    <svg width={W} height={H} viewBox={`0 0 ${W} ${H}`} className="block">
      <path d={path} fill="none" stroke={color} strokeWidth={2} strokeLinejoin="round" strokeLinecap="round" />
    </svg>
  );
}

function MonthBars({
  data,
  todayIndex,
  showForecast = true,
}: {
  data: number[]; // Ğ´Ğ»Ğ¸Ğ½Ğ° = ĞºĞ¾Ğ»-Ğ²Ñƒ Ğ´Ğ½ĞµĞ¹ Ğ¼ĞµÑÑÑ†Ğ°
  todayIndex: number; // 0..n-1
  showForecast?: boolean;
}) {
  const H = 100;
  const max = Math.max(1, ...data);
  const avg7 = sma(data, 7);
  return (
    <div className="relative">
      <div className="grid grid-cols-31 gap-1 items-end h-[120px]">
        {data.map((v, i) => {
          const h = (v / max) * H + 6;
          const isToday = i === todayIndex;
          const isFuture = i > todayIndex;
          return (
            <div key={i} className="relative flex items-end justify-center">
              <div
                className={`w-2.5 rounded-t-md ${isFuture ? "bg-sky-500/30" : "bg-sky-500"}`}
                style={{ height: `${h}px`, opacity: isFuture && showForecast ? 0.5 : 1 }}
                title={`${i + 1}: ${toCurrency(v)}`}
              />
              {isToday && (
                <div className="absolute inset-0 border border-white/90 dark:border-white rounded-md pointer-events-none" />
              )}
            </div>
          );
        })}
      </div>
      {/* SMA Ğ»Ğ¸Ğ½Ğ¸Ñ */}
      <svg className="absolute left-0 right-0 top-0" height={120} width="100%" preserveAspectRatio="none">
        {(() => {
          const W = 31 * 10 + 30; // Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ´ ÑĞµÑ‚ĞºÑƒ
          const Hsvg = 120;
          const pts = avg7.map((v, i) => {
            const x = (i / (data.length - 1)) * (W - 10) + 5;
            const y = Hsvg - (v / max) * (Hsvg - 20) - 10;
            return `${i === 0 ? "M" : "L"}${x.toFixed(1)},${y.toFixed(1)}`;
          });
          return <path d={pts.join(" ")} fill="none" stroke="rgba(255,255,255,0.9)" strokeWidth={1.8} strokeLinejoin="round" strokeLinecap="round" />;
        })()}
      </svg>
    </div>
  );
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
function TxRow({ tx, mask, onEdit, onDelete, onDuplicate, onTemplate }: any) {
  const amtClass = tx.amount >= 0 ? "text-emerald-600 dark:text-emerald-400" : "text-rose-600 dark:text-rose-400";
  return (
    <div className="p-3 rounded-xl border bg-white/60 dark:bg-white/5 backdrop-blur-xl border-black/10 dark:border-white/10 flex items-center justify-between">
      <div className="flex items-center gap-3">
        <div className={`w-9 h-9 rounded-xl grid place-items-center ${tx.amount < 0 ? "bg-rose-500/15" : "bg-emerald-500/15"}`}>
          {tx.amount < 0 ? <ArrowDownCircle size={18} className="text-rose-500" /> : <ArrowUpCircle size={18} className="text-emerald-500" />}
        </div>
        <div>
          <div className="font-semibold text-gray-900 dark:text-white leading-tight">{tx.title}</div>
          <div className="text-xs text-gray-600 dark:text-gray-300">{tx.category} â€¢ {tx.time}</div>
        </div>
      </div>
      <div className="flex items-center gap-2">
        <div className={`min-w-[86px] text-right font-semibold ${amtClass}`}>{mask ? "â€¢â€¢â€¢â€¢" : toCurrency(Math.abs(tx.amount))}</div>
        <button title="Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ" onClick={onEdit} className="w-8 h-8 grid place-items-center rounded-lg bg-black/5 dark:bg-white/10"><Edit3 size={16} /></button>
        <button title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ" onClick={onDelete} className="w-8 h-8 grid place-items-center rounded-lg bg-black/5 dark:bg-white/10"><Trash2 size={16} /></button>
        <button title="Ğ”ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ" onClick={onDuplicate} className="w-8 h-8 grid place-items-center rounded-lg bg-black/5 dark:bg-white/10"><Copy size={16} /></button>
        <button title="Ğ’ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½" onClick={onTemplate} className="w-8 h-8 grid place-items-center rounded-lg bg-black/5 dark:bg-white/10"><BookmarkPlus size={16} /></button>
      </div>
    </div>
  );
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// FABâ€‘Ğ»ÑƒÑ‡
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
function FabRay({ label, icon, open, order, onClick }: any) {
  const offset = 64 * order;
  return (
    <button
      title={label}
      onClick={onClick}
      className={`absolute right-0 bottom-0 w-12 h-12 grid place-items-center rounded-2xl border bg-white dark:bg-white/10 border-black/10 dark:border-white/15 shadow-lg transition-all duration-200 ${open ? `translate-y-[-${offset}px] opacity-100` : "opacity-0 pointer-events-none"}`}
    >
      {icon}
    </button>
  );
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// Ğ“Ğ›ĞĞ’ĞĞ«Ğ™ ĞšĞĞœĞŸĞĞĞ•ĞĞ¢
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
export default function LeoraFinance() {
  const [dark, setDark] = useState(true); // Premium: dark-first
  const rootRef = useRef<HTMLDivElement>(null);
  useEffect(() => {
    const el = rootRef.current;
    if (!el) return;
    if (dark) el.classList.add("dark");
    else el.classList.remove("dark");
  }, [dark]);

  // ĞŸĞ•Ğ Ğ˜ĞĞ”
  const [period, setPeriod] = useState({ month: 8, year: 2025 }); // Ğ°Ğ²Ğ³ÑƒÑÑ‚ 2025
  const monthName = useMemo(() => new Date(period.year, period.month - 1, 1).toLocaleDateString("ru-RU", { month: "long", year: "numeric" }), [period]);
  const daysInMonth = useMemo(() => new Date(period.year, period.month, 0).getDate(), [period]);
  const todayIdx = new Date().getMonth() + 1 === period.month && new Date().getFullYear() === period.year ? new Date().getDate() - 1 : 14;

  // ĞœĞĞ”Ğ•Ğ›Ğ˜ Ğ”ĞĞĞĞ«Ğ¥ (Ğ´ĞµĞ¼Ğ¾)
  const [mask, setMask] = useState(false);
  const [fanOpen, setFanOpen] = useState(false);
  const [activeTab, setActiveTab] = useState<'tx'|'budgets'|'goals'|'analytics'|'settlements'>('tx');

  const txData = useMemo(() => ([
    { date: "Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ", items: [
      { id: 1, title: "ĞšĞ¾Ñ„Ğµ", category: "Ğ•Ğ´Ğ° Ğ¸ Ğ½Ğ°Ğ¿Ğ¸Ñ‚ĞºĞ¸", amount: -280, time: "09:30" },
      { id: 2, title: "Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚", category: "Ğ¢Ğ°ĞºÑĞ¸", amount: -460, time: "10:10" },
      { id: 3, title: "Ğ¤Ñ€Ğ¸Ğ»Ğ°Ğ½Ñ", category: "Ğ”Ğ¾Ñ…Ğ¾Ğ´", amount: 12500, time: "12:15" },
    ]},
    { date: "Ğ’Ñ‡ĞµÑ€Ğ°", items: [
      { id: 4, title: "Ğ¡ÑƒĞ¿ĞµÑ€Ğ¼Ğ°Ñ€ĞºĞµÑ‚", category: "ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹", amount: -2100, time: "19:40" },
      { id: 5, title: "ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°", category: "Ğ¡ĞµÑ€Ğ²Ğ¸ÑÑ‹", amount: -299, time: "08:05" },
    ]},
  ]), []);

  // Ğ‘ÑĞ´Ğ¶ĞµÑ‚Ñ‹ Ğ¸ Ñ†ĞµĞ»Ğ¸
  const budgets = useMemo(() => ([
    { id: 'food', name: 'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹', spent: 12600, limit: 15000 },
    { id: 'transport', name: 'Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚', spent: 7600, limit: 9000 },
    { id: 'fun', name: 'Ğ Ğ°Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ', spent: 9200, limit: 8000 }, // Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½Ğ¸Ğµ
  ]), []);
  const goals = useMemo(() => ([
    { id: 'vac', name: 'ĞÑ‚Ğ¿ÑƒÑĞº Ğ² Ğ¾ĞºÑ‚ÑĞ±Ñ€Ğµ', saved: 82000, target: 120000 },
    { id: 'mac', name: 'ĞĞ¾Ğ²Ñ‹Ğ¹ MacBook', saved: 55000, target: 180000 },
  ]), []);

  // Ğ’Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹ (IOU) â€” ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ² Ñ Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¼ ÑĞ°Ğ»ÑŒĞ´Ğ¾ Ğ¿Ğ¾ Ğ´Ğ¾Ğ»Ğ³Ğ°Ğ¼
  const settlements = useMemo(() => ([
    { id: 'anna', name: 'ĞĞ½Ğ½Ğ°', net: -1200, last: 'Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ 10:40' }, // Ğ²Ñ‹ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹
    { id: 'oleg', name: 'ĞĞ»ĞµĞ³', net: 2300, last: 'Ğ’Ñ‡ĞµÑ€Ğ° 19:10' },   // Ğ¾Ğ½ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ²Ğ°Ğ¼
    { id: 'maria', name: 'ĞœĞ°Ñ€Ğ¸Ñ', net: 0, last: '3 Ğ´Ğ½Ñ Ğ½Ğ°Ğ·Ğ°Ğ´' },
  ]), []);

  const settlementsTotals = useMemo(() => calcSettlementsTotals(settlements), [settlements]);

  // ĞœĞµÑÑÑ‡Ğ½Ñ‹Ğµ Ñ‚Ñ€Ğ°Ñ‚Ñ‹ (Ğ´ĞµĞ¼Ğ¾â€‘Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)
  const monthData = useMemo(() => {
    const n = daysInMonth;
    const base = Array.from({ length: n }, (_, i) => 2000 + Math.round(Math.sin(i / 3) * 800 + Math.random() * 900));
    // Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞµ: Ñ‡ÑƒÑ‚ÑŒ Ğ²Ñ‹ÑˆĞµ ÑÑ€ĞµĞ´Ğ½ĞµĞ³Ğ¾ ĞºĞ°Ğº Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·
    for (let i = todayIdx + 1; i < n; i++) base[i] = base[i] * 1.08;
    return base;
  }, [daysInMonth, todayIdx]);

  // Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ¸ ÑÑƒĞ¼Ğ¼Ñ‹
  const expensesToday = useMemo(() => (txData[0]?.items ?? []).filter((t:any) => t.amount < 0).reduce((a:number,b:any)=>a+Math.abs(b.amount),0), [txData]);
  const incomeToday = useMemo(() => (txData[0]?.items ?? []).filter((t:any) => t.amount > 0).reduce((a:number,b:any)=>a+Math.abs(b.amount),0), [txData]);
  const balance = 385000; // Ğ´ĞµĞ¼Ğ¾

  // ĞĞ»ĞµÑ€Ñ‚Ñ‹ Ğ±ÑĞ´Ğ¶ĞµÑ‚Ğ° (Ğ»ÑĞ±Ğ°Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ > 90%)
  const budgetAlerts = budgets.filter(b => (b.spent / b.limit) > 0.9);

  // Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚
  function doExport(fmt: 'csv'|'pdf'|'xlsx') {
    toast(`Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ ${fmt.toUpperCase()} Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ»ĞµĞ½`);
  }

  // ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ°
  function prevMonth(){ setPeriod(p=>{ const d=new Date(p.year,p.month-2,1); return { month: d.getMonth()+1, year: d.getFullYear() }; }); }
  function nextMonth(){ setPeriod(p=>{ const d=new Date(p.year,p.month,1); return { month: d.getMonth()+1, year: d.getFullYear() }; }); }

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // Ğ Ğ•ĞĞ”Ğ•Ğ 
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  return (
    <div ref={rootRef} className="min-h-screen bg-white dark:bg-black text-gray-900 dark:text-white">
      {/* HEADER */}
      <div className="sticky top-0 z-20 bg-gradient-to-b from-white to-gray-50 dark:from-black dark:to-black/60 backdrop-blur supports-[backdrop-filter]:bg-white/80 dark:supports-[backdrop-filter]:bg-black/60">
        <div className="flex items-center justify-between px-5 pt-12 pb-5">
          <div className="flex items-center gap-3">
            <div className="w-11 h-11 rounded-xl grid place-items-center shadow-md bg-gradient-to-br from-gray-900 to-gray-700 text-white">
              <Wallet size={22} />
            </div>
            <div>
              <h1 className="m-0 text-[26px] font-semibold tracking-tight">Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹</h1>
              <p className="m-0 mt-0.5 text-[13px] text-gray-500 dark:text-gray-400">ĞŸÑ€ĞµĞ¼Ğ¸ÑƒĞ¼ â€¢ Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½â€‘Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ â€¢ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <button className="w-10 h-10 grid place-items-center rounded-xl bg-black/5 dark:bg-white/10" title="ĞŸĞ¾Ğ¸ÑĞº"><Search size={18} className="text-gray-500 dark:text-gray-400" /></button>
            <button className="w-10 h-10 grid place-items-center rounded-xl bg-black/5 dark:bg-white/10" title="Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹"><Filter size={18} className="text-gray-500 dark:text-gray-400" /></button>
            <button onClick={() => doExport('csv')} className="w-10 h-10 grid place-items-center rounded-xl bg-black/5 dark:bg-white/10" title="Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ CSV"><Download size={18} className="text-gray-500 dark:text-gray-400" /></button>
            <button onClick={() => setMask(v=>!v)} className="w-10 h-10 grid place-items-center rounded-xl bg-black/5 dark:bg-white/10" title={mask?"ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑƒĞ¼Ğ¼Ñ‹":"Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ ÑÑƒĞ¼Ğ¼Ñ‹"}>{mask ? <Unlock size={18} className="text-gray-500 dark:text-gray-400"/> : <Lock size={18} className="text-gray-500 dark:text-gray-400"/>}</button>
            <button onClick={() => setDark(v=>!v)} className="ml-1 px-3 h-10 grid place-items-center rounded-xl border border-black/10 dark:border-white/15 text-xs text-gray-600 dark:text-gray-200">{dark?"ğŸŒ™ Dark":"ğŸŒ• Light"}</button>
          </div>
        </div>
      </div>

      {/* PERIOD PICKER + SUMMARY */}
      <div className="px-5">
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center gap-2">
            <button onClick={prevMonth} className="w-9 h-9 grid place-items-center rounded-lg bg-black/5 dark:bg-white/10"><ChevronLeft size={18}/></button>
            <div className="px-3 py-2 rounded-xl border bg-white/60 dark:bg-white/5 backdrop-blur-xl border-black/10 dark:border-white/10 text-sm font-semibold">{monthName}</div>
            <button onClick={nextMonth} className="w-9 h-9 grid place-items-center rounded-lg bg-black/5 dark:bg-white/10"><ChevronRight size={18}/></button>
          </div>
          <div className="text-xs text-gray-500 dark:text-gray-400">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾</div>
        </div>

        {/* Balance Card */}
        <div className="p-4 rounded-2xl border bg-white/70 dark:bg-white/5 backdrop-blur-xl border-black/10 dark:border-white/10 mb-4">
          <div className="flex items-center justify-between">
            <div>
              <div className="text-[13px] text-gray-500 dark:text-gray-400">ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ</div>
              <div className="text-2xl font-semibold">{mask?"â€¢â€¢â€¢â€¢â€¢â€¢â€¢":toCurrency(balance)}</div>
            </div>
            <div>
              <Sparkline points={monthData.slice(0, Math.min(monthData.length, todayIdx+1))} color={dark?"#fff":"#0ea5e9"} />
            </div>
          </div>
          <div className="grid grid-cols-2 gap-3 mt-2">
            <div className="p-3 rounded-xl bg-emerald-500/10 dark:bg-emerald-500/15">
              <div className="text-xs text-gray-600 dark:text-gray-300">Ğ”Ğ¾Ñ…Ğ¾Ğ´ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</div>
              <div className="text-[18px] font-semibold text-emerald-600 dark:text-emerald-400">{mask?"â€¢â€¢â€¢â€¢":toCurrency(incomeToday)}</div>
            </div>
            <div className="p-3 rounded-xl bg-rose-500/10 dark:bg-rose-500/15">
              <div className="text-xs text-gray-600 dark:text-gray-300">Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</div>
              <div className="text-[18px] font-semibold text-rose-600 dark:text-rose-400">{mask?"â€¢â€¢â€¢â€¢":toCurrency(expensesToday)}</div>
            </div>
          </div>
        </div>

        {/* Month Bars */}
        <div className="p-4 rounded-2xl border bg-white/70 dark:bg-white/5 backdrop-blur-xl border-black/10 dark:border-white/10 mb-4">
          <div className="flex items-center gap-2 mb-2">
            <BarChart2 size={18} className="text-gray-600 dark:text-gray-300"/>
            <div className="font-semibold">Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹ Ğ·Ğ° Ğ¼ĞµÑÑÑ†</div>
            <div className="ml-auto text-xs text-gray-500 dark:text-gray-400 flex items-center gap-2"><span className="inline-block w-3 h-3 bg-sky-500 rounded-sm"/> Ñ„Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ <span className="inline-block w-3 h-3 bg-sky-500/30 rounded-sm"/> Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· <span className="inline-block w-4 h-[2px] bg-white/90 rounded"/> SMA 7Ğ´</div>
          </div>
          <MonthBars data={monthData} todayIndex={todayIdx} showForecast />
        </div>

        {/* Budget alert */}
        {budgetAlerts.length>0 && (
          <div className="p-3 mb-4 rounded-2xl border bg-amber-500/10 dark:bg-amber-500/15 border-amber-300/30 flex items-center gap-3">
            <AlertTriangle size={18} className="text-amber-500"/>
            <div className="text-sm">ĞŸĞ¾Ñ€Ğ¾Ğ³ Ğ±ÑĞ´Ğ¶ĞµÑ‚Ğ°: {budgetAlerts.map(b=>b.name).join(', ')} â€” Ğ±Ğ»Ğ¸Ğ·ĞºĞ¾ Ğº Ğ¿Ñ€ĞµĞ´ĞµĞ»Ñƒ. <button className="underline" onClick={()=>setActiveTab('budgets')}>ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ</button></div>
          </div>
        )}
      </div>

      {/* TABS */}
      <div className="px-5">
        <div className="flex items-center gap-2 mb-3">
          {([
            { id:'tx', label:'Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸' },
            { id:'budgets', label:'Ğ‘ÑĞ´Ğ¶ĞµÑ‚Ñ‹' },
            { id:'goals', label:'Ğ¦ĞµĞ»Ğ¸' },
            { id:'settlements', label:'Ğ’Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹' },
            { id:'analytics', label:'ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°' },
          ] as const).map(t => (
            <button key={t.id}
              onClick={()=>setActiveTab(t.id)}
              className={`px-3 py-2 rounded-xl border text-sm ${activeTab===t.id? 'bg-black/80 text-white dark:bg-white/20 dark:text-white border-black/0 dark:border-white/0':'bg-white/70 dark:bg-white/5 border-black/10 dark:border-white/10 text-gray-700 dark:text-gray-200'}`}
            >{t.label}</button>
          ))}
        </div>

        {/* TAB CONTENTS */}
        {activeTab==='tx' && (
          <div className="grid gap-4 pb-28">
            {/* ĞĞµĞ¾Ğ±Ñ‹Ñ‡Ğ½Ğ°Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ */}
            <div className="p-3 rounded-2xl border bg-white/70 dark:bg-white/5 backdrop-blur-xl border-black/10 dark:border-white/10">
              <div className="flex items-start gap-3">
                <div className="w-10 h-10 rounded-xl grid place-items-center bg-rose-500/15"><AlertTriangle size={18} className="text-rose-500"/></div>
                <div className="flex-1">
                  <div className="font-semibold mb-0.5">ĞĞµĞ¾Ğ±Ñ‹Ñ‡Ğ½Ğ°Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ</div>
                  <div className="text-sm text-gray-600 dark:text-gray-300">Ğ¢Ñ€Ğ°Ñ‚Ğ° Ğ² ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ Â«Ğ Ğ°Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸ÑÂ» Ğ²Ñ‹ÑˆĞµ ÑÑ€ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ½Ğ° 42%. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¸ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ?</div>
                  <div className="mt-2 flex gap-2">
                    <button onClick={()=>toast('ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¾')} className="px-3 py-2 rounded-xl border bg-white dark:bg-transparent/20 border-black/10 dark:border-white/10 text-sm">ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ</button>
                    <button onClick={()=>toast('ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ°')} className="px-3 py-2 rounded-xl border bg-white dark:bg-transparent/20 border-black/10 dark:border-white/10 text-sm">Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ</button>
                  </div>
                </div>
              </div>
            </div>

            {txData.map((day:any, idx:number)=> (
              <div key={idx}>
                <div className="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-2">{day.date}</div>
                <div className="grid gap-2">
                  {day.items.map((t:any)=> (
                    <TxRow key={t.id} tx={t} mask={mask}
                      onEdit={()=>toast('Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ')}
                      onDelete={()=>toast('Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ (UNDO 5Ñ)')}
                      onDuplicate={()=>toast('Ğ”ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾')}
                      onTemplate={()=>toast('Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾ ĞºĞ°Ğº ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½')}
                    />
                  ))}
                </div>
              </div>
            ))}

            {/* Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ */}
            <div className="flex items-center justify-end gap-2">
              <button onClick={()=>doExport('csv')} className="px-3 py-2 rounded-xl border bg-white dark:bg-transparent/20 border-black/10 dark:border-white/10 text-sm">Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ CSV</button>
              <button onClick={()=>doExport('pdf')} className="px-3 py-2 rounded-xl border bg-white dark:bg-transparent/20 border-black/10 dark:border-white/10 text-sm">PDF</button>
              <button onClick={()=>doExport('xlsx')} className="px-3 py-2 rounded-xl border bg-white dark:bg-transparent/20 border-black/10 dark:border-white/10 text-sm">Excel</button>
            </div>
          </div>
        )}

        {activeTab==='budgets' && (
          <div className="grid gap-3 pb-28">
            {budgets.map(b=> {
              const pct = clamp((b.spent / b.limit) * 100, 0, 999);
              const tone = pct < 60 ? 'bg-emerald-500' : pct < 90 ? 'bg-amber-500' : 'bg-rose-500';
              return (
                <div key={b.id} className="p-4 rounded-2xl border bg-white/70 dark:bg-white/5 backdrop-blur-xl border-black/10 dark:border-white/10">
                  <div className="flex items-center justify-between mb-2">
                    <div className="font-semibold">{b.name}</div>
                    <div className="text-sm text-gray-600 dark:text-gray-300">Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ {mask?"â€¢â€¢â€¢â€¢":toCurrency(Math.max(0, b.limit - b.spent))}</div>
                  </div>
                  <div className="h-3 rounded-xl bg-black/5 dark:bg-white/10 overflow-hidden">
                    <div className={`h-full ${tone}`} style={{ width: `${Math.min(100,pct)}%` }} />
                  </div>
                  <div className="flex items-center justify-between mt-2 text-sm">
                    <div className="text-gray-600 dark:text-gray-300">{mask?"â€¢â€¢â€¢â€¢":toCurrency(b.spent)} / {mask?"â€¢â€¢â€¢â€¢":toCurrency(b.limit)}</div>
                    <div className="flex items-center gap-2">
                      <button onClick={()=>toast('Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚')} className="px-3 py-1.5 rounded-xl border bg-white dark:bg-transparent/20 border-black/10 dark:border-white/10 text-sm">Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚</button>
                      <button onClick={()=>toast('Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ°')} className="px-3 py-1.5 rounded-xl border bg-white dark:bg-transparent/20 border-black/10 dark:border-white/10 text-sm">Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ</button>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {activeTab==='goals' && (
          <div className="grid gap-3 pb-28">
            {goals.map(g=> {
              const pct = clamp((g.saved / g.target) * 100, 0, 100);
              return (
                <div key={g.id} className="p-4 rounded-2xl border bg-white/70 dark:bg-white/5 backdrop-blur-xl border-black/10 dark:border-white/10">
                  <div className="flex items-center gap-3 mb-2">
                    <div className="w-10 h-10 rounded-xl grid place-items-center bg-sky-500/15"><PiggyBank size={18} className="text-sky-500"/></div>
                    <div className="font-semibold">{g.name}</div>
                  </div>
                  <div className="h-3 rounded-xl bg-black/5 dark:bg-white/10 overflow-hidden">
                    <div className="h-full bg-emerald-500" style={{ width: `${pct}%` }} />
                  </div>
                  <div className="flex items-center justify-between mt-2 text-sm">
                    <div className="text-gray-600 dark:text-gray-300">{mask?"â€¢â€¢â€¢":toCurrency(g.saved)} / {mask?"â€¢â€¢â€¢":toCurrency(g.target)}</div>
                    <div className="flex items-center gap-2">
                      <button onClick={()=>toast('Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ²Ğ·Ğ½Ğ¾Ñ')} className="px-3 py-1.5 rounded-xl border bg-white dark:bg-transparent/20 border-black/10 dark:border-white/10 text-sm">+ Ğ’Ğ·Ğ½Ğ¾Ñ</button>
                      <button onClick={()=>toast('ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½')} className="px-3 py-1.5 rounded-xl border bg-white dark:bg-transparent/20 border-black/10 dark:border-white/10 text-sm">ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {activeTab==='settlements' && (
          <div className="grid gap-3 pb-28">
            {/* Ğ¡Ğ²Ğ¾Ğ´ĞºĞ° Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ² */}
            <div className="p-4 rounded-2xl border bg-white/70 dark:bg-white/5 backdrop-blur-xl border-black/10 dark:border-white/10">
              <div className="flex items-center gap-2 mb-1">
                <Users size={18} className="text-gray-600 dark:text-gray-300"/>
                <div className="font-semibold">Ğ’Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹</div>
              </div>
              <div className="flex flex-wrap gap-2">
                <span className="px-3 py-1.5 rounded-full border bg-black/5 dark:bg-white/10 border-black/10 dark:border-white/10 text-sm">
                  Ğ’Ñ‹ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ <b className="font-semibold">{mask ? 'â€¢â€¢â€¢â€¢' : toCurrency(settlementsTotals.youOwe)}</b>
                </span>
                <span className="px-3 py-1.5 rounded-full border bg-black/5 dark:bg-white/10 border-black/10 dark:border-white/10 text-sm">
                  Ğ’Ğ°Ğ¼ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ <b className="font-semibold">{mask ? 'â€¢â€¢â€¢â€¢' : toCurrency(settlementsTotals.oweYou)}</b>
                </span>
              </div>
            </div>

            {/* Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ */}
            <div className="flex justify-end mb-1">
              <button onClick={()=>toast('ĞĞ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ (Ğ´Ğ¾Ğ»Ğ³/Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚)')} className="px-3 py-2 rounded-xl border bg-white dark:bg-transparent/20 border-black/10 dark:border-white/10 text-sm inline-flex items-center gap-2"><UserPlus size={16}/> Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ</button>
            </div>

            {/* Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ² */}
            {settlements.map((s:any)=>(
              <div key={s.id} className="p-3 rounded-2xl border bg-white/70 dark:bg-white/5 backdrop-blur-xl border-black/10 dark:border-white/10">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="w-9 h-9 rounded-xl grid place-items-center bg-sky-500/15"><Users size={18} className="text-sky-500"/></div>
                    <div>
                      <div className="font-semibold">{s.name}</div>
                      <div className="text-xs text-gray-600 dark:text-gray-300">{s.last}</div>
                    </div>
                  </div>
                  <div className={`min-w-[110px] text-right font-semibold ${s.net>0 ? 'text-emerald-600 dark:text-emerald-400' : s.net<0 ? 'text-rose-600 dark:text-rose-400' : 'text-gray-500 dark:text-gray-400'}`}>
                    {mask ? 'â€¢â€¢â€¢â€¢' : (s.net===0 ? '0 â‚½' : (s.net>0 ? `+${toCurrency(s.net)}` : `âˆ’${toCurrency(Math.abs(s.net))}`))}
                  </div>
                </div>
                <div className="mt-2 flex gap-2">
                  {s.net>0 && <button onClick={()=>toast('ĞĞ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾')} className="px-3 py-1.5 rounded-xl border bg-white dark:bg-transparent/20 border-black/10 dark:border-white/10 text-sm inline-flex items-center gap-2"><Bell size={16}/> ĞĞ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ñ‚ÑŒ</button>}
                  {s.net<0 && <button onClick={()=>toast('ĞŸĞ¾Ğ³Ğ°ÑˆĞµĞ½Ğ¸Ğµ Ğ´Ğ¾Ğ»Ğ³Ğ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾')} className="px-3 py-1.5 rounded-xl border bg-white dark:bg-transparent/20 border-black/10 dark:border-white/10 text-sm inline-flex items-center gap-2"><Check size={16}/> ĞŸĞ¾Ğ³Ğ°ÑĞ¸Ñ‚ÑŒ</button>}
                </div>
              </div>
            ))}
          </div>
        )}

        {activeTab==='analytics' && (
          <div className="grid gap-3 pb-28">
            <div className="p-4 rounded-2xl border bg-white/70 dark:bg-white/5 backdrop-blur-xl border-black/10 dark:border-white/10">
              <div className="flex items-center gap-2 mb-2"><PieChart size={18} className="text-gray-600 dark:text-gray-300"/><div className="font-semibold">Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ¾Ğ²</div></div>
              <div className="grid grid-cols-4 gap-3">
                {[{n:'ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹',v:34,c:'bg-emerald-500'},{n:'Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚',v:22,c:'bg-sky-500'},{n:'Ğ Ğ°Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ',v:18,c:'bg-rose-500'},{n:'Ğ¡ĞµÑ€Ğ²Ğ¸ÑÑ‹',v:12,c:'bg-amber-500'}].map((x,i)=> (
                  <div key={i} className="p-3 rounded-xl border bg-white/60 dark:bg-white/5 border-black/10 dark:border-white/10">
                    <div className="text-sm text-gray-600 dark:text-gray-300">{x.n}</div>
                    <div className="text-2xl font-semibold">{x.v}%</div>
                    <div className="h-2 rounded bg-black/5 dark:bg-white/10 mt-2 overflow-hidden"><div className={`h-full ${x.c}`} style={{width:`${x.v}%`}}/></div>
                  </div>
                ))}
              </div>
            </div>

            <div className="p-4 rounded-2xl border bg-white/70 dark:bg-white/5 backdrop-blur-xl border-black/10 dark:border-white/10">
              <div className="flex items-center gap-2 mb-2"><CalendarClock size={18} className="text-gray-600 dark:text-gray-300"/><div className="font-semibold">Ğ”ĞµĞ½ĞµĞ¶Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ‚Ğ¾Ğº (30 Ğ´Ğ½ĞµĞ¹)</div></div>
              <Sparkline points={monthData} color={dark?"#fff":"#111"} />
            </div>
          </div>
        )}
      </div>

      {/* FAB â€” Ğ²ĞµĞµÑ€ */}
      <div className="fixed right-5 bottom-24 z-40">
        <div className="relative w-14 h-14">
          <FabRay label="Ğ Ğ°ÑÑ…Ğ¾Ğ´" icon={<ArrowDownCircle size={18}/>} open={fanOpen} order={1} onClick={()=>toast('Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ€Ğ°ÑÑ…Ğ¾Ğ´ (AI ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ)')} />
          <FabRay label="Ğ”Ğ¾Ñ…Ğ¾Ğ´" icon={<ArrowUpCircle size={18}/>} open={fanOpen} order={2} onClick={()=>toast('Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ¾Ñ…Ğ¾Ğ´')} />
          <FabRay label="ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´" icon={<ArrowRightLeft size={18}/>} open={fanOpen} order={3} onClick={()=>toast('ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑÑ‡ĞµÑ‚Ğ°Ğ¼Ğ¸')} />
          <FabRay label="Ğ”Ğ¾Ğ»Ğ³" icon={<DollarSign size={18}/>} open={fanOpen} order={4} onClick={()=>toast('Ğ”Ğ¾Ğ»Ğ³/Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ (Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ)')} />
          <button onClick={()=>setFanOpen(v=>!v)} aria-label="Add" className="w-14 h-14 rounded-full grid place-items-center text-white shadow-xl border border-white/10 bg-gradient-to-br from-gray-900 to-gray-700"><Plus size={26} /></button>
        </div>
      </div>

      {/* FOOTER GAP */}
      <div className="h-24"/>
    </div>
  );
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// TOAST
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
function toast(text: string) {
  const el = document.createElement("div");
  el.textContent = text;
  el.className = "fixed bottom-40 right-5 bg-gray-900 text-white dark:bg-white dark:text-black px-3.5 py-2.5 rounded-xl shadow-lg text-sm opacity-0 animate-[toastIn_0.2s_ease_forwards] z-[60]";
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1800);
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// ĞœĞ˜ĞĞ˜â€‘Ğ¢Ğ•Ğ¡Ğ¢Ğ« (Ğ½Ğµ Ğ¼ĞµĞ½ÑÑÑ‚ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ UI)
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
(() => {
  // clamp
  console.assert(clamp(5, 0, 10) === 5, "clamp: within range");
  console.assert(clamp(-1, 0, 10) === 0, "clamp: low bound");
  console.assert(clamp(99, 0, 10) === 10, "clamp: high bound");

  // sma
  const smaRes = sma([1, 2, 3], 2);
  const smaExpected = [1, 1.5, 2.5];
  console.assert(JSON.stringify(smaRes) === JSON.stringify(smaExpected), "sma: window=2");

  // currency
  console.assert(toCurrency(1000).includes("â‚½"), "toCurrency: has RUB sign");

  // settlements totals
  const totals = calcSettlementsTotals([{ net: -1200 }, { net: 2300 }, { net: 0 }]);
  console.assert(totals.youOwe === 1200 && totals.oweYou === 2300, "calcSettlementsTotals: basic case");
})();
